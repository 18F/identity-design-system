# Jobs defined here use the idp/ci docker image from ECR by default.
# Images are built via the identity-devops GitLab pipeline.

variables:
  BUNDLER_VERSION: '2.3.13'
  NVM_VERSION: 'v0.39.0'
  NODE_VERSION: 'latest'
  ECR_REGISTRY: '${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com'
  IDP_WORKER_IMAGE_TAG: 'main'
  IDP_IMAGE_TAG: 'main'
  PKI_IMAGE_TAG: 'main'

default:
  image: '${ECR_REGISTRY}/dashboard/ci:latest'

.bundle-npm-install: &bundle_npm_install
  - export BASH_ENV="$HOME/.bash.env"
  - gem install bundler --version $BUNDLER_VERSION
  - wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/$NVM_VERSION/install.sh | bash
  - export NVM_DIR="$HOME/.nvm"
  - . "$NVM_DIR/nvm.sh" --install --latest-npm
  - echo 'export NVM_DIR="$HOME/.nvm"' >> $BASH_ENV
  - echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> $BASH_ENV
  - gem install bundler --version $BUNDLER_VERSION
  - bundle check --path ~/.bundler || bundle install --path ~/.bundler
  - npm ci

bundle-npm-install:
  script:
    - *bundle_npm_install
  cache:
    paths:
      - ~/.npm
      - ~/.bundler

lints:
  needs:
    - bundle-npm-install
  script:
    - make lint

integration:
  needs:
    - bundle-npm-install
  script:
    - npm test
  variables:
    SKIP_VISUAL_REGRESSION_TEST: 'true'

snapshot-main:
  script:
    - git clone -b main --single-branch https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.login.gov/lg/identity-design-system.git
    - cd identity-design-system
    - *bundle_npm_install
    - make -j2 build-assets build-docs
    - scripts/snapshot.js
  artifacts:
    paths:
      - tmp/screenshot/branches
  except:
    - main

snapshot-branch:
  needs:
    - bundle-npm-install
  script:
    - make -j2 build-assets build-docs
    - scripts/snapshot.js
  artifacts:
    paths:
      - tmp/screenshot/branches
  except:
    - main

visual-regression:
  needs:
    - snapshot-main
    - snapshot-branch
  script:
    - *bundle_npm_install
    - npm test
  variables:
    only_VISUAL_REGRESSION_TEST: 'true'
  except:
    - main
  dependencies:
    - snapshot-branch
    - snapshot-main
